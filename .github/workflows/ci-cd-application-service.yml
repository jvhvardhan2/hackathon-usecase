name: CI/CD - Application Service

on:
  push:
    branches: [main, develop]
    paths:
      - 'application-service/**'
      - 'k8s/base/application-service-*.yaml'
      - '.github/workflows/ci-cd-application-service.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'application-service/**'

env:
  SERVICE_NAME: application-service
  GCP_REGION: us-central1
  GKE_CLUSTER: healthcare-gke-dev
  NAMESPACE: healthcare

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ${{ env.SERVICE_NAME }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ env.SERVICE_NAME }}

      - name: Run tests
        run: npm test
        working-directory: ${{ env.SERVICE_NAME }}

      - name: Build application
        run: npm run build --if-present
        working-directory: ${{ env.SERVICE_NAME }}

  docker-build-push:
    name: Docker Build and Push to GCR
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Generate image tag
        id: image-tag
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          IMAGE_TAG="${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/healthcare-docker-dev/${{ env.SERVICE_NAME }}:${SHORT_SHA}"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ env.SERVICE_NAME }}
          push: true
          tags: |
            ${{ steps.image-tag.outputs.image_tag }}
            ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/healthcare-docker-dev/${{ env.SERVICE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image details
        run: |
          echo "### Docker Image Built Successfully ðŸ³" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ steps.image-tag.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**SHA:** ${{ steps.image-tag.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY

    outputs:
      image_tag: ${{ steps.image-tag.outputs.image_tag }}
      short_sha: ${{ steps.image-tag.outputs.short_sha }}

  deploy-to-gke:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: docker-build-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region=${{ env.GCP_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }}

      - name: Update K8s deployment
        run: |
          kubectl set image deployment/${{ env.SERVICE_NAME }} \
            ${{ env.SERVICE_NAME }}=${{ needs.docker-build-push.outputs.image_tag }} \
            -n ${{ env.NAMESPACE }}
          
          kubectl rollout status deployment/${{ env.SERVICE_NAME }} -n ${{ env.NAMESPACE }}

      - name: Verify deployment
        run: |
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=${{ env.SERVICE_NAME }}
          kubectl get svc -n ${{ env.NAMESPACE }} -l app=${{ env.SERVICE_NAME }}

      - name: Deployment summary
        run: |
          echo "### Deployment Successful âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ needs.docker-build-push.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** ${{ env.GKE_CLUSTER }}" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace:** ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
